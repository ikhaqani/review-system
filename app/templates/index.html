{% extends "base.html" %}

{% block head %}
  {{ super() }}
  {# Font Awesome is nog steeds nodig voor andere iconen als u die gebruikt,
     maar niet meer voor de +/- van de accordeon als we die functionaliteit verwijderen.
     Voor nu laten we het staan, mocht u het elders gebruiken.
  #}
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
{% endblock %}

{# MACRO voor een enkele commentaar (ongewijzigd) #}
{% macro render_item_comment(comment) %}
<div class="comment">
  <div class="comment-author">{{ comment.author_name }}</div>
  <div class="comment-text">{{ comment.comment_text | replace('\n','<br>') | safe }}</div>
  <div class="comment-meta">{{ comment.created_at.strftime('%Y-%m-%d %H:%M') if comment.created_at else 'Zojuist' }}</div>
</div>
{% endmacro %}

{# MACRO voor de Question Grid layout (ongewijzigd) #}
{% macro render_question_grid(node, comments_by_path) %}
  {% if node.is_leaf %}
    {% set label = node.name.value if node.name else 'Onbekende vraag' %}
    {% set path = node.element_path_for_comments %}
    {% set comments = comments_by_path.get(path, []) %}
    {% set temp_path_for_id = path | string | replace('.', '-') | replace('[', '_') | replace(']', '_') | replace(',', '_') | replace('(', '_') | replace(')', '_') | replace('/', '_') | replace(' ', '_') %}
    {% set html_id_prefix = 'q-' ~ (temp_path_for_id | lower | truncate(60,'')) %}

    <div class="question-grid list-group-item {% if node.level and node.level > 0 %}level-{{ node.level }}-question{% endif %}">
      <div class="question-details">
        <div class="question-name-line">
            <span class="question-name-text">{{ label }}</span>
            {% if node.min is not none and node.max is not none %}
                <span class="occurrence ms-1">[{{ node.min }}..{% if node.max == -1 %}*{% else %}{{ node.max }}{% endif %}]</span>
            {% endif %}
        </div>
        <div class="question-value-area">
          {% if node.value %}
            {% if node.value._type=='DV_CODED_TEXT' %}
              <select class="form-select form-select-sm professional-select" placeholder="Typ om te zoeken...">
                  <option value="">-- Selecteer {{ node.value.options|length if node.value.options else '0' }} optie(s) --</option>
                  {% for option_item in node.value.options %}
                      <option value="{{ option_item.value }}" {% if option_item.value == node.value.value %}selected{% endif %}>{{ option_item.label }}</option>
                  {% endfor %}
              </select>
            {% elif node.value._type=='DV_BOOLEAN' %}
              <div class="d-flex gap-3">
                <div class="form-check">
                  <input class="form-check-input" type="radio" name="bool_{{ html_id_prefix }}" id="yes-{{ html_id_prefix }}" value="true" {{ 'checked' if node.value.value is sameas(true) }}>
                  <label class="form-check-label" for="yes-{{ html_id_prefix }}">Ja</label>
                </div>
                <div class="form-check">
                  <input class="form-check-input" type="radio" name="bool_{{ html_id_prefix }}" id="no-{{ html_id_prefix }}" value="false" {{ 'checked' if node.value.value is sameas(false) }}>
                  <label class="form-check-label" for="no-{{ html_id_prefix }}">Nee</label>
                </div>
              </div>
            {% elif node.value._type == 'DV_DATE' %}
                <input type="date" class="form-control form-control-sm" value="{{ node.value.value if node.value.value is not none else '' }}">
            {% elif node.value._type == 'DV_DATE_TIME' %}
                <input type="datetime-local" class="form-control form-control-sm" value="{{ node.value.value if node.value.value is not none else '' }}">
            {% else %}
                <input type="text" class="form-control form-control-sm" placeholder="Tekst…" value="{{ node.value.value or '' }}">
            {% endif %}
          {% else %}
            <input type="text" class="form-control form-control-sm" value="(Geen invoer)" readonly>
          {% endif %}
        </div>
      </div>
      <div class="comments-section">
        <h3 class="comment-title">Opmerkingen</h3>
        <div class="comments-list" id="comments-list-{{ html_id_prefix }}">
          {% if comments %}
            {% for comment in comments|sort(attribute='created_at') %}
              {{ render_item_comment(comment) }}
            {% endfor %}
          {% else %}
            <p class="text-muted fst-italic small no-comments-yet">Nog geen opmerkingen.</p>
          {% endif %}
        </div>
        <form method="post" class="inline-comment-form">
          <input type="hidden" name="element_path" value="{{ path }}">
          <input type="hidden" name="author_name" class="global-author-name-sync">
          <textarea name="comment_text" class="form-control form-control-sm" rows="3" placeholder="Typ een opmerking..." required></textarea>
          <button type="submit" class="btn btn-primary btn-sm w-100 mt-2">Plaats</button>
        </form>
      </div>
    </div>
  {% endif %}
{% endmacro %}

{# --- AANGEPAST: Macro zonder accordion collapse functionaliteit --- #}
{% macro render_questionnaire_structure(items, parent_id_prefix_for_children, comments_by_path, loop_prefix) %}
    {% for node in items %}
      {% set temp_node_id_for_html = node.archetype_node_id | string | replace('.', '-') | replace('[', '_') | replace(']', '_') | replace(',', '_') | replace('(', '_') | replace(')', '_') | replace('/', '_') | replace(' ', '_') %}
      {% set node_id_html = (loop_prefix ~ "-" ~ (loop.index0|string) ~ "-" ~ temp_node_id_for_html | lower | truncate(60,'')) %}
      {# collapse_target_id is niet meer nodig #}

      {% if node.is_leaf %}
        {{ render_question_grid(node, comments_by_path) }}
      {% else %} {# Dit is een container (SECTION, EVALUATION, CLUSTER, etc.) #}
        <div class="accordion-item {% if node.level and node.level > 0 %}level-{{ node.level }}{% endif %}">
            <h2 class="accordion-header" id="heading-{{ node_id_html }}">
                {# De button is nu een div, data-bs-* attributen zijn verwijderd #}
                <div class="accordion-button-static"> 
                    {# --- AANGEPAST: Punt toegevoegd na sectienummer --- #}
                    {% if node.section_number %}
                        <span class="section-number">{{ node.section_number }}.</span>
                    {% endif %}
                    {{ node.name.value }}
                    {% if node.min is not none and node.max is not none %}
                        <span class="occurrence ms-2">[{{ node.min }}..{% if node.max == -1 %}*{% else %}{{ node.max }}{% endif %}]</span>
                    {% endif %}
                </div>
            </h2>
            {# De body is nu altijd zichtbaar. id, data-bs-parent, collapse en show classes zijn verwijderd. #}
            <div class="accordion-body">
                {{ render_questionnaire_structure(node.children, "children-of-" ~ node_id_html, comments_by_path, loop_prefix ~ "-" ~ loop.index0) }}
            </div>
        </div>
      {% endif %}
    {% endfor %}
{% endmacro %}


{% block content %}
<div class="main-container">
    <div class="content-panel" id="contentPanel">
        <div class="questionnaire-title-bar">
            <div class="d-flex flex-column">
              <h1 class="h3 mb-1">{{ questionnaire.name.value if questionnaire.name else 'Vragenlijst' }}
                {% if questionnaire and questionnaire.version %}
                    <span class="badge bg-primary text-white ms-2 fw-normal">v{{ questionnaire.version }}</span>
                {% endif %}
              </h1>
              {% if total_sections > 0 %}
                <span class="text-muted small">Sectie {{ current_section_index + 1 }} van {{ total_sections }}</span>
              {% endif %}
            </div>
            <div>
                <label for="globalAuthorName" class="form-label fw-semibold small">Uw reviewer naam:</label>
                <input id="globalAuthorName" class="form-control form-control-sm" style="max-width: 300px;" placeholder="Jan Janssen…">
            </div>
        </div>
        {% if current_section %}
            {# De div hieronder had class "accordion", kan nu weg of een generieke class krijgen als nodig voor styling #}
            <div class="sections-container" id="singleSectionContainer"> 
                {{ render_questionnaire_structure([current_section], "singleSection", comments_by_path, "L0") }}
            </div>
        {% else %}
            <div class="alert alert-warning m-3">Geen inhoud beschikbaar voor deze sectie.</div>
        {% endif %}
        <div class="pagination-controls">
            {% if current_section_index > 0 %}
                <a href="{{ url_for('main.form_page', section_index=current_section_index - 1) }}" class="btn btn-secondary">
                    <i class="fas fa-arrow-left me-2"></i> Vorige Sectie
                </a>
            {% else %}
                <a href="#" class="btn btn-secondary invisible" aria-hidden="true">Vorige Sectie</a>
            {% endif %}

            {% if current_section_index < total_sections - 1 %}
                <a href="{{ url_for('main.form_page', section_index=current_section_index + 1) }}" class="btn btn-primary">
                    Volgende Sectie <i class="fas fa-arrow-right ms-2"></i>
                </a>
            {% else %}
                <button type="button" class="btn btn-success" onclick="alert('Vragenlijst voltooid!')">
                    Vragenlijst Voltooien <i class="fas fa-check ms-2"></i>
                </button>
            {% endif %}
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', () => {
  const globalNameInput = document.getElementById('globalAuthorName');
  const storageKey = 'reviewerName';

  function syncGlobalAuthorName() {
    const authorName = globalNameInput.value.trim();
    localStorage.setItem(storageKey, authorName);
    document.querySelectorAll('.global-author-name-sync').forEach(input => {
      input.value = authorName;
    });
  }

  if (globalNameInput) {
    globalNameInput.value = localStorage.getItem(storageKey) || '';
    syncGlobalAuthorName();
    globalNameInput.addEventListener('input', syncGlobalAuthorName);
  }
  
  // De Bootstrap accordion initialisatie is niet meer nodig als we geen accordeon gebruiken.
  // var accordionTriggers = document.querySelectorAll('.accordion-button')
  // accordionTriggers.forEach(function (trigger) {
  //   ...
  // });

  document.querySelectorAll('.professional-select').forEach((el) => {
    new TomSelect(el, {
      create: false,
      sortField: {
        field: "text",
        direction: "asc"
      },
      plugins: ['clear_button'], 
    });
  });
});
</script>
{% endblock %}
